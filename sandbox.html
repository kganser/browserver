<!doctype html>
<html>
  <head>
    <script src="/lib/kernel.js"></script>
    <script src="/lib/proxy.js"></script>
    <script>
      kernel.use({proxy: 0}, function(o) {
        var apps = {}, host = o.proxy({
          run: function(args) {
            if (apps[args[0]]) return; // TODO: support multiple workers per app
            // TODO: determine if iframe proxy is necessary. workers might be sufficient
            (apps[args[0]] = o.proxy({
              database_get: function(args, callback) { host.send('database_get', args, callback); },
              database_put: function(args, callback) { host.send('database_put', args, callback); },
              database_append: function(args, callback) { host.send('database_append', args, callback); },
              database_delete: function(args, callback) { host.send('database_delete', args, callback); },
              socket_listen: function(args, callback) { host.send('socket_listen', args, callback, true); },
              socket_read: function(args, callback) { host.send('socket_read', args, callback, true); },
              socket_write: function(args, callback) { host.send('socket_write', args, callback); },
              socket_disconnect: function(args, callback) { host.send('socket_disconnect', args, callback); }
            }, URL.createObjectURL(new Blob([args[1]], {type: 'text/javascript'})), true)).peer.onerror = function(e) {
              host.send('error', [args[0], e.message, e.filename, e.lineno]);
            };
          },
          stop: function(args) {
            if (!apps[args[0]]) return;
            apps[args[0]].peer.terminate();
            delete apps[args[0]];
          }
        });
      });
    </script>
  </head>
</html>